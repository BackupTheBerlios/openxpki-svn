#!/bin/sh
#
# OpenXPKI Configuration Script
#
# Written by Martin Bartosch for the OpenXPKI project 2006
# Copyright (c) 2006 by The OpenXPKI Project
# $Revision: 80 $
#

CFG="bin/openxpki-metaconf"

TEMPLATEDIR=etc/templates
TEMPLATE="default"

INTERACTIVE=1
CHECKMODULES=1

while [ -n "$1" ] ; do
    case "$1" in
	--batch)
	    echo "Entering batch mode..."
	    INTERACTIVE=0
	    shift
	    ;;
	--nocheck)
	    echo "Not checking for OpenXPKI base modules..."
	    CHECKMODULES=0
	    shift
	    ;;
	--)
	    shift
	    METACONF_OPTS="$*"
	    echo "Additional options to openxpki-metaconf: '$METACONF_OPTS'"
	    shift $#
	    ;;
    esac
done


# check that all required perl modules are present

if [ "$CHECKMODULES" = "1" ] ; then
    if ! perl check_modules.pl; then
	echo "If you already installed OpenXPKI's Perl modules"
	echo "then you forget perhaps to set the correct include path."
	echo "Example: PERL5LIB=/usr/local/openxpki/lib/perl/5.8.4 ./configure"
	exit 1;
    fi
fi

# provide fresh default configuration (if not already present)
if [ ! -e openxpki.conf ] ; then
    cp etc/openxpki.conf .
fi

if [ ! -e openxpki.conf ] ; then
    echo "ERROR: could not find 'openxpki.conf' in current directory"
    exit 1
fi

echo
echo "OpenXPKI Installation Program"
echo "Copyright (c) 2006 by The OpenXPKI Project"
echo
echo "Ready to begin initial configuration. First of all we will need to figure"
echo "out the basic settings required for installation of the support programs."
echo "This configuration script will ask you several questions about the desired"
echo "setup and generate an installation Makefile."
echo "Running 'make install' will then create the necessary directories and install"
echo "a base configuration set."
echo

# interactively create initial configuration
if [ "$INTERACTIVE" = "1" ] ; then
    $CFG --config openxpki.conf --includesection dir,file,deployment --interactive --force --writecfg openxpki.conf
fi

if [ -n "$METACONF_OPTS" ] ; then
    
    $CFG --config openxpki.conf --force $METACONF_OPTS --writecfg openxpki.conf
fi

# write makefile
$CFG --config openxpki.conf --file $TEMPLATEDIR/$TEMPLATE/Makefile >Makefile

echo "Initial configuration complete. You may now run"
echo
echo "make install"
echo
echo "in order to install the OpenXPKI server files."
echo
echo "You may wish to review the generated meta configuration file"
echo "'openxpki.conf' in this directory before proceeding."
echo
