#!/bin/sh
#
# OpenXPKI Configuration Script
#
# Written by Martin Bartosch for the OpenXPKI project 2006
# Copyright (c) 2006 by The OpenXPKI Project
# $Revision$
#

CFG="bin/openxpki-metaconf"

TEMPLATEDIR="etc/templates"
TEMPLATE="default"

INTERACTIVE=1
CHECKMODULES=1

usage() {
    cat <<EOF
Usage: configure [OPTIONS]

Prepare OpenXPKI for installation.

Options:
   --help         display this help text and exit
   --batch        non-interactive configuration
   --nocheck      do not check for presence of required Perl modules
   --             all options following -- are passed to openxpki-metaconf

When called without arguments this script interactively queries
several installation settings from the user that are required for
installation of the software.

Calling it with --batch performs this configuration without asking
any questions. This is most useful in conjunction with the -- feature
that allows passing settings to openxpki-metaconf.

See below for examples.

configure generates two files in the current directory:
- openxpki.conf   is generated by openxpki-metaconf during the configuration
                  step and contains the user specified settings
- Makefile        is the actual OpenXPKI installer

After configure has created both files, you may wish to install the
software via

make install

After running 'make install' this configure script and the contents
of the deployment directory are no longer needed and may be removed.


Examples:

Interactive configuration:

./configure

Non-interactive configuration example:

./configure  --batch --nocheck -- --setcfg dir.prefix=/home/johndoe/local \\
--setcfg file.openssl=/opt/local/bin/openssl \\
--setcfg deployment.xmlstyle=multi-file \\
--setcfg server.runuser=johndoe \\
--setcfg server.rungroup=johndoe


EOF

}


while [ -n "$1" ] ; do
    case "$1" in
	--help)
	    usage
	    exit 0
	    ;;
	--batch)
	    echo "Entering batch mode..."
	    INTERACTIVE=0
	    shift
	    ;;
	--nocheck)
	    echo "Not checking for OpenXPKI base modules..."
	    CHECKMODULES=0
	    shift
	    ;;
	--)
	    shift
	    METACONF_OPTS="$*"
	    echo "Additional options to openxpki-metaconf: '$METACONF_OPTS'"
	    shift $#
	    ;;
	*)
	    echo "Unrecognized option $1"
	    exit 1
	    ;;
    esac
done


# check that all required perl modules are present

if [ "$CHECKMODULES" = "1" ] ; then
    if ! perl check_modules.pl; then
	echo "If you already installed OpenXPKI's Perl modules"
	echo "then you forget perhaps to set the correct include path."
	echo "Example: PERL5LIB=/usr/local/openxpki/lib/perl/5.8.4 ./configure"
	exit 1;
    fi
fi

# provide fresh default configuration (if not already present)
if [ ! -e openxpki.conf ] ; then
    cp etc/openxpki.conf .
fi

if [ ! -e openxpki.conf ] ; then
    echo "ERROR: could not find 'openxpki.conf' in current directory"
    exit 1
fi

echo
echo "OpenXPKI Installation Program"
echo "Copyright (c) 2006 by The OpenXPKI Project"
echo
echo "Ready to begin initial configuration. First of all we will need to figure"
echo "out the basic settings required for installation of the support programs."
echo "This configuration script will ask you several questions about the desired"
echo "setup and generate an installation Makefile."
echo "Running 'make install' will then create the necessary directories and install"
echo "a base configuration set."
echo

# interactively create initial configuration
if [ "$INTERACTIVE" = "1" ] ; then
    $CFG --config openxpki.conf --includesection dir,file,deployment --interactive --force --writecfg openxpki.conf
fi

if [ -n "$METACONF_OPTS" ] ; then
    
    $CFG --config openxpki.conf --force $METACONF_OPTS --writecfg openxpki.conf
fi

# write makefile
$CFG --config openxpki.conf --file $TEMPLATEDIR/$TEMPLATE/Makefile >Makefile

echo "Initial configuration complete. You may now run"
echo
echo "make install"
echo
echo "in order to install the OpenXPKI server files."
echo
echo "You may wish to review the generated meta configuration file"
echo "'openxpki.conf' in this directory before proceeding."
echo
